# –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã 502 Bad Gateway

## üìå –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

–ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –æ—Ç–∫—Ä—ã—Ç—å —Å–∞–π—Ç vezuroll.ru –≤ –±—Ä–∞—É–∑–µ—Ä–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –æ—à–∏–±–∫–∞:
```
502 Bad Gateway
nginx/1.24.0 (Ubuntu)
```

## üîç –ü—Ä–∏—á–∏–Ω—ã –æ—à–∏–±–∫–∏ 502

–û—à–∏–±–∫–∞ 502 Bad Gateway –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ Nginx –Ω–µ –º–æ–∂–µ—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ upstream-—Å–µ—Ä–≤–∏—Å—É (PHP-FPM –∏–ª–∏ Python backend). –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:

1. **PHP-FPM –Ω–µ –∑–∞–ø—É—â–µ–Ω** - —Å–∞–º–∞—è —á–∞—Å—Ç–∞—è –ø—Ä–∏—á–∏–Ω–∞
2. **Python backend –Ω–µ –∑–∞–ø—É—â–µ–Ω**
3. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—É—Ç—å –∫ PHP-FPM —Å–æ–∫–µ—Ç—É**
4. **–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–∞–º—è—Ç–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ**
5. **–û—à–∏–±–∫–∏ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx**

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ PHP-FPM
sudo systemctl status php8.3-fpm
# –∏–ª–∏ –¥–ª—è –¥—Ä—É–≥–∏—Ö –≤–µ—Ä—Å–∏–π PHP
sudo systemctl status php-fpm

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Python backend
sudo systemctl status iiko-backend

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Nginx
sudo systemctl status nginx
```

### –®–∞–≥ 2: –ó–∞–ø—É—Å–∫ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

#### –ï—Å–ª–∏ PHP-FPM –Ω–µ –∑–∞–ø—É—â–µ–Ω:
```bash
# –î–ª—è PHP 8.3
sudo systemctl start php8.3-fpm
sudo systemctl enable php8.3-fpm

# –î–ª—è –¥—Ä—É–≥–∏—Ö –≤–µ—Ä—Å–∏–π
sudo systemctl start php-fpm
sudo systemctl enable php-fpm
```

#### –ï—Å–ª–∏ Python backend –Ω–µ –∑–∞–ø—É—â–µ–Ω:
```bash
sudo systemctl start iiko-backend
sudo systemctl enable iiko-backend
```

#### –ï—Å–ª–∏ Nginx –Ω–µ –∑–∞–ø—É—â–µ–Ω:
```bash
sudo systemctl start nginx
sudo systemctl enable nginx
```

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ –Ω–∞ –æ—à–∏–±–∫–∏

```bash
# –õ–æ–≥–∏ Nginx
sudo tail -50 /var/log/nginx/error.log
sudo tail -50 /var/log/nginx/iiko-base-error.log

# –õ–æ–≥–∏ PHP-FPM
sudo tail -50 /var/log/php8.3-fpm.log
# –∏–ª–∏
sudo journalctl -u php8.3-fpm -n 50

# –õ–æ–≥–∏ Python backend
sudo journalctl -u iiko-backend -n 50
```

### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞
sudo nginx -t

# –ï—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏, –∏—Å–ø—Ä–∞–≤—å—Ç–µ –∏—Ö –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
sudo nano /etc/nginx/sites-available/iiko-base
```

### –®–∞–≥ 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ PHP-FPM —Å–æ–∫–µ—Ç–∞

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Å–æ–∫–µ—Ç–∞
ls -la /var/run/php/php8.3-fpm.sock

# –ï—Å–ª–∏ —Å–æ–∫–µ—Ç –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é PHP-FPM
sudo nano /etc/php/8.3/fpm/pool.d/www.conf

# –ù–∞–π–¥–∏—Ç–µ —Å—Ç—Ä–æ–∫—É —Å listen –∏ —É–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –æ–Ω–∞ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ —Å–æ–∫–µ—Ç
# listen = /var/run/php/php8.3-fpm.sock
```

### –®–∞–≥ 6: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã:

```bash
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
cd /var/www/iiko-base
sudo ./scripts/deploy.sh
```

–ò–ª–∏ –≤—Ä—É—á–Ω—É—é:

```bash
sudo systemctl restart php8.3-fpm
sudo systemctl restart iiko-backend
sudo systemctl restart nginx
```

## üöÄ –ë—ã—Å—Ç—Ä–æ–µ —Ä–µ—à–µ–Ω–∏–µ (–≤ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–µ —Å–ª—É—á–∞–µ–≤)

–í 90% —Å–ª—É—á–∞–µ–≤ –ø—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–∞–µ—Ç—Å—è –ø—Ä–æ—Å—Ç—ã–º –∑–∞–ø—É—Å–∫–æ–º PHP-FPM:

```bash
sudo systemctl start php8.3-fpm
sudo systemctl enable php8.3-fpm
sudo systemctl restart nginx
```

## üìä –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–æ–≤

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ PHP-FPM —á–µ—Ä–µ–∑ —Å–æ–∫–µ—Ç
sudo -u www-data SCRIPT_FILENAME=/var/www/iiko-base/frontend/public/index.php \
     REQUEST_METHOD=GET \
     cgi-fcgi -bind -connect /var/run/php/php8.3-fpm.sock

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Python backend
curl http://localhost:8000/health

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Nginx
curl -I http://localhost/
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ —Å–µ—Ä–≤–µ—Ä–∞

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏
free -h

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –¥–∏—Å–∫–∞
df -h

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
ps aux | grep -E 'php-fpm|uvicorn|nginx'
```

## üîß –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥—Ä—É–≥–∞—è –≤–µ—Ä—Å–∏—è PHP

–ï—Å–ª–∏ –Ω–∞ –≤–∞—à–µ–º —Å–µ—Ä–≤–µ—Ä–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –¥—Ä—É–≥–∞—è –≤–µ—Ä—Å–∏—è PHP (–Ω–∞–ø—Ä–∏–º–µ—Ä, 7.4 –∏–ª–∏ 8.0), –æ–±–Ω–æ–≤–∏—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Nginx:

```bash
# –£–∑–Ω–∞–π—Ç–µ –≤–µ—Ä—Å–∏—é PHP
php -v

# –ù–∞–π–¥–∏—Ç–µ –ø—É—Ç—å –∫ PHP-FPM —Å–æ–∫–µ—Ç—É
sudo find /var/run/php/ -name "*.sock"

# –û–±–Ω–æ–≤–∏—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Nginx
sudo nano /etc/nginx/sites-available/iiko-base

# –ò–∑–º–µ–Ω–∏—Ç–µ —Å—Ç—Ä–æ–∫—É fastcgi_pass –Ω–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –ø—É—Ç—å
# fastcgi_pass unix:/var/run/php/php8.0-fpm.sock;
```

### –£–≤–µ–ª–∏—á–µ–Ω–∏–µ —Ç–∞–π–º–∞—É—Ç–æ–≤

–ï—Å–ª–∏ —Å–µ—Ä–≤–∏—Å –º–µ–¥–ª–µ–Ω–Ω—ã–π, —É–≤–µ–ª–∏—á—å—Ç–µ —Ç–∞–π–º–∞—É—Ç—ã –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx:

```nginx
location ~ \.php$ {
    # ... –¥—Ä—É–≥–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ...
    
    # –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–µ —Ç–∞–π–º–∞—É—Ç—ã
    fastcgi_connect_timeout 60s;
    fastcgi_send_timeout 60s;
    fastcgi_read_timeout 60s;
}
```

## üìù –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

1. **–í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å**: –æ—Ç–∫—Ä–æ–π—Ç–µ http://vezuroll.ru –≤ –±—Ä–∞—É–∑–µ—Ä–µ
2. **API**: –æ—Ç–∫—Ä–æ–π—Ç–µ http://api.vezuroll.ru/health
3. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API**: –æ—Ç–∫—Ä–æ–π—Ç–µ http://api.vezuroll.ru/api/v1/docs

## ‚ö†Ô∏è –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏

### –û—à–∏–±–∫–∞: "connect() to unix:/var/run/php/php8.3-fpm.sock failed"

**–ü—Ä–∏—á–∏–Ω–∞**: PHP-FPM –Ω–µ –∑–∞–ø—É—â–µ–Ω –∏–ª–∏ —Å–æ–∫–µ—Ç –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

**–†–µ—à–µ–Ω–∏–µ**:
```bash
sudo systemctl start php8.3-fpm
sudo systemctl enable php8.3-fpm
```

### –û—à–∏–±–∫–∞: "upstream timed out"

**–ü—Ä–∏—á–∏–Ω–∞**: PHP-FPM –∏–ª–∏ backend —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–ª–∏—à–∫–æ–º –º–µ–¥–ª–µ–Ω–Ω–æ

**–†–µ—à–µ–Ω–∏–µ**: –£–≤–µ–ª–∏—á—å—Ç–µ —Ç–∞–π–º–∞—É—Ç—ã –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx (—Å–º. –≤—ã—à–µ)

### –û—à–∏–±–∫–∞: "Permission denied"

**–ü—Ä–∏—á–∏–Ω–∞**: Nginx –Ω–µ –∏–º–µ–µ—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ PHP-FPM —Å–æ–∫–µ—Ç—É

**–†–µ—à–µ–Ω–∏–µ**:
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–æ–∫–µ—Ç—É
ls -la /var/run/php/php8.3-fpm.sock

# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Nginx –∑–∞–ø—É—â–µ–Ω –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è www-data
ps aux | grep nginx

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ /etc/php/8.1/fpm/pool.d/www.conf
# user = www-data
# group = www-data
# listen.owner = www-data
# listen.group = www-data
```

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ —Ä–µ—à–µ–Ω–∞ –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö —à–∞–≥–æ–≤:

1. –°–æ–±–µ—Ä–∏—Ç–µ –ª–æ–≥–∏ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
2. –°–¥–µ–ª–∞–π—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç –æ—à–∏–±–∫–∏ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
3. –°–æ–∑–¥–∞–π—Ç–µ issue –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ GitHub —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –æ–ø–∏—Å–∞–Ω–∏–µ–º

## üîó –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [DATABASE_ERRORS.md](./DATABASE_ERRORS.md) - —Ä–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å PostgreSQL
- [FAQ.md](./FAQ.md) - —á–∞—Å—Ç–æ –∑–∞–¥–∞–≤–∞–µ–º—ã–µ –≤–æ–ø—Ä–æ—Å—ã
- [INSTALLATION.md](./INSTALLATION.md) - —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ
